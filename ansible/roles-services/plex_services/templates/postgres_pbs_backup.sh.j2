#!/bin/bash
#
# PostgreSQL Backup Script for Plex Services using Proxmox Backup Server
# Backs up PostgreSQL databases directly to PBS with deduplication
#
set -euo pipefail

# Configuration
BACKUP_DIR="/tmp/postgres_pbs_backup"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="/var/log/postgres_pbs_backup.log"

# PostgreSQL connection details
POSTGRES_USER="{{ postgres_user | default('qstick') }}"
POSTGRES_PASSWORD="{{ postgres_password | default('qstick') }}"
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432"

# PBS Configuration
{% if pbs_backup_enabled | default(true) %}
PBS_ENV_FILE="/etc/proxmox-backup/pbs-client.env"
PBS_NAMESPACE="{{ postgres_pbs_namespace | default('databases') }}"
PBS_ENABLED=true

# Source PBS environment file for credentials
if [ -f "$PBS_ENV_FILE" ]; then
    source "$PBS_ENV_FILE"
else
    log "ERROR: PBS environment file not found at $PBS_ENV_FILE"
    PBS_ENABLED=false
fi
{% else %}
PBS_ENABLED=false
{% endif %}

# Backup hostname for PBS (defaults to actual hostname)
BACKUP_HOSTNAME="{{ inventory_hostname | default(ansible_hostname) }}"

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Error handling
error_exit() {
    log "ERROR: $1"
    # Cleanup temp directory on error
    rm -rf "$BACKUP_DIR"
    exit 1
}

# Cleanup function
cleanup() {
    log "Cleaning up temporary files..."
    rm -rf "$BACKUP_DIR"
}
trap cleanup EXIT

# Create temp backup directory
mkdir -p "$BACKUP_DIR"

log "Starting PostgreSQL PBS backup process"

# Check if PBS is available
if [ "$PBS_ENABLED" = true ]; then
    if ! command -v proxmox-backup-client &> /dev/null; then
        error_exit "proxmox-backup-client not found. Install with: apt install proxmox-backup-client"
    fi
    
    # Test PBS connection and create namespace if needed
    log "Testing PBS connection..."
    set +e  # Temporarily disable exit on error for PBS test
    proxmox-backup-client snapshot list --ns "$PBS_NAMESPACE" &>/dev/null
    PBS_TEST_EXIT=$?
    set -e  # Re-enable exit on error
    
    if [ $PBS_TEST_EXIT -ne 0 ] && [ $PBS_TEST_EXIT -ne 255 ]; then
        log "WARNING: Cannot connect to PBS (exit code: $PBS_TEST_EXIT), falling back to local backup only"
        PBS_ENABLED=false
    else
        # Create namespace if it doesn't exist (ENOENT means namespace doesn't exist yet)
        if [ $PBS_TEST_EXIT -eq 255 ]; then
            log "Namespace '$PBS_NAMESPACE' doesn't exist, creating it..."
            set +e
            proxmox-backup-client namespace create "$PBS_NAMESPACE"
            CREATE_EXIT=$?
            set -e
            if [ $CREATE_EXIT -eq 0 ]; then
                log "Successfully created namespace '$PBS_NAMESPACE'"
            else
                log "WARNING: Failed to create namespace (exit code: $CREATE_EXIT), falling back to local backup only"
                PBS_ENABLED=false
            fi
        fi
    fi
fi

# First, backup global objects (roles, tablespaces, etc.)
log "Backing up global objects (roles, tablespaces, etc.)"
GLOBALS_FILE="$BACKUP_DIR/postgres_globals_${TIMESTAMP}.sql"
docker exec postgres pg_dumpall -U "$POSTGRES_USER" --globals-only > "$GLOBALS_FILE"

if [ $? -eq 0 ]; then
    gzip "$GLOBALS_FILE"
    log "Successfully created globals backup: ${GLOBALS_FILE}.gz"
else
    error_exit "Failed to backup global objects"
fi

# Get list of databases (excluding system databases)
DATABASES=$(docker exec postgres psql -U "$POSTGRES_USER" -d "{{ postgres_default_db | default('radarr-main') }}" -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname NOT IN ('postgres', 'template0', 'template1');" | grep -v '^$' | tr -d ' ')

if [ -z "$DATABASES" ]; then
    log "No user databases found to backup"
    exit 0
fi

# Backup each database using custom format
for DB in $DATABASES; do
    log "Backing up database: $DB"
    BACKUP_FILE="$BACKUP_DIR/${DB}_${TIMESTAMP}.dump"
    
    # Create compressed backup in custom format (better for pg_restore)
    # Dump inside container, redirect to host filesystem
    docker exec postgres pg_dump -U "$POSTGRES_USER" -Fc "$DB" > "$BACKUP_FILE"
    
    if [ $? -ne 0 ]; then
        log "WARNING: Failed to backup database: $DB"
        continue
    fi
    
    log "Successfully created backup: $BACKUP_FILE"
done

# Upload to PBS if enabled
if [ "$PBS_ENABLED" = true ]; then
    log "Uploading backups to Proxmox Backup Server..."
    
    # Create backup ID (PBS adds timestamp automatically)
    BACKUP_ID="postgres"
    
    log "Backing up to PBS repository: $PBS_REPOSITORY"
    
    # Execute PBS backup - backup the entire directory
    # The .pxar format archives directories, so we backup the whole backup dir
    proxmox-backup-client backup \
        "postgres-backups.pxar:$BACKUP_DIR" \
        --ns "$PBS_NAMESPACE" \
        --backup-id "$BACKUP_ID" \
        --backup-time "$(date +%s)"
    
    if [ $? -eq 0 ]; then
        log "Successfully uploaded backups to PBS"
        
        # List recent backups
        log "Recent PBS backups:"
        proxmox-backup-client snapshot list --ns "$PBS_NAMESPACE" | tail -n 5
    else
        log "WARNING: Failed to upload backups to PBS"
    fi
else
    log "PBS backup disabled or unavailable, backups remain in $BACKUP_DIR"
    log "WARNING: Local backups will be deleted on script exit unless PBS is enabled"
fi

log "PostgreSQL PBS backup process completed successfully"
