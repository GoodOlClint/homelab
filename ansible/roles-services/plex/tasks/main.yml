---
- name: Install NVIDIA GRID driver
  import_role:
    name: nvidia

- name: Download Plex APT GPG key to temp file
  ansible.builtin.get_url:
    url: https://downloads.plex.tv/plex-keys/PlexSign.key
    dest: /tmp/plex.gpg.key
    mode: '0644'

- name: Convert Plex GPG key to dearmored format
  ansible.builtin.command:
    cmd: gpg --batch --dearmor -o /usr/share/keyrings/plex.gpg /tmp/plex.gpg.key
  args:
    creates: /usr/share/keyrings/plex.gpg

- name: Add Plex official APT repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/plex.gpg] https://downloads.plex.tv/repo/deb public main"
    state: present
    filename: plexmediaserver

- name: Install latest Plex Media Server
  ansible.builtin.apt:
    name: plexmediaserver
    state: latest
    update_cache: yes

- name: Ensure NFS packages.
  ansible.builtin.package:
    name:
      - nfs-common
    state: present

- name: Ensure NFS fstab entry and mount.
  ansible.posix.mount:
    backup: yes
    boot: "yes"
    path: "/mnt/media"
    src: "{{ plex_nfs_src }}"
    fstype: nfs
    opts: "defaults"
    state: "mounted"